name: Auto Register & Update Subscription

on:
  schedule:
    - cron: "0 */3 * * *"   # 每3小时执行一次
  workflow_dispatch:        # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # ✅ 拉取完整提交历史

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Run Register Script
      run: |
        echo "▶ 运行注册脚本..."
        node "vpn/main.js" > subscribe_url.txt
        echo "✅ 生成订阅链接如下："
        cat subscribe_url.txt

    - name: Download Subscription File
      run: |
        echo "▶ 开始下载订阅文件..."
        URL=$(cat subscribe_url.txt)
        if [ -z "$URL" ]; then
          echo "❌ 未能获取到订阅链接"
          exit 1
        fi
        curl -sL "$URL" -o subscribe.txt
        echo "✅ 已保存为 subscribe.txt"

    - name: Commit & Push Changes
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "▶ 准备提交更新..."
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        # ✅ 关键一步：拉取最新版本，防止 push 冲突
        git pull origin main --rebase || true

        git add subscribe.txt
        git commit -m "Update subscribe link $(date +'%Y-%m-%d %H:%M:%S')" || echo "⚠️ 没有变化"
        git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git" main
        echo "✅ 推送完成"
